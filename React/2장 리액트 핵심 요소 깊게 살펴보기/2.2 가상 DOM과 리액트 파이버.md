## 2.2 가상 DOM과 리액트 파이버

---

### DOM과 브라우저 렌더링 과정

> **DOM**(Document Object Model): 웹페이지에 대한 인터페이스로 **브라우저가 웹페이지의 콘텐츠와 구조를 어떻게 보여줄지에 대한 정보**를 담고 있음

💡 **브라우저가 웹사이트 접근 요청을 받고 화면을 그릴 때**

1. **브라우저**가 사용자가 요청한 주소를 방문해 **HTML 파일을 다운로드**
2. 브라우저의 **렌더링 엔진**이 HTML을 파싱해 **DOM 트리**를 만든다
3. 2번에서 CSS 파일을 만나면 **CSS 파일도 다운로드** 한다
4. 브라우저의 **렌더링 엔진**이 CSS도 파싱해 **CSSOM 트리**를 만든다
5. 브라우저가 DOM 노드를 순회하며 **사용자 눈에 보이는 노드만 방문**한다
6. 눈에 보이는 노드에 대한 CSSOM 정보를 찾고 발견한 **CSS 스타일 정보를 노드에 적용**
   - CSS 적용 과정
     - **레이아웃**(layout, reflow): 각 노드가 브라우저 화면의 어느 좌표에 나타나야 하는지 계산
     - **페인팅**(painting): 색과 같은 실제 유효한 모습을 그린다

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/7fcc553f-a6b8-4870-a93c-292d8556f276/b8be912f-6d0a-4b9a-b8bd-f4b4a34c9777/image.png)

### 가상 DOM의 탄생 배경

요즘 대다수의 앱은 렌더링된 이후에도 **사용자의 인터랙션**을 통해 다양한 정보를 노출

⇒ **렌더링이 완료된 이후**에도 **사용자의 인터랙션으로 웹페이지가 변경되는 사항도 고려**해야 함

- e.g. 특정한 요소의 노출 여부가 변경되거나 사이즈가 변경되는 경우
  → 레이아웃과 리페인팅이 발생하기 때문에 비용이 소모된다
- **SPA**의 경우 하나의 페이지에서 계속해서 요소의 위치를 재계산하게 됨
  → 사용자는 깜빡임 없이 자연스러운 탐색을 할 수 있지만 그만큼 DOM 관리 비용이 커짐

개발자: 인터랙션에 모든 DOM의 변경보다는 **결과적으로 만들어지는 DOM 결과물 하나만** 알고 싶음 ⇒ **가상 DOM**

<aside>
💡

**가상 DOM:**
웹 페이지가 표시해야 할 DOM을 일단 메모리에 저장하고, **리액트(react-dom)가 실제 변경에 대한 준비가 완료됐을 때 실제 브라우저의 DOM에 반영**

</aside>

⇒ DOM 계산을 브라우저가 아닌 메모리에서 계산하는 과정을 거치므로 렌더링 과정을 최소화하고 브라우저와 개발자의 부담을 덜 수 있음

🚨 리액트의 가상 DOM 방식이 브라우저의 일반적인 DOM 관리 방식보다 무조건 빠른 것이 아님.

### 가상 DOM을 위한 아키텍처, 리액트 파이버

> 리액트 파이버: 리액트에서 관리하는 평범한 자바스크립트 객체, 파이버 재조정자(fiber reconciler)가 관리

- **가상 DOM과 실제 DOM을 비교해 변경 사항을 수집** → 차이가 있으면 변경에 관련된 정보를 가지고 파이버를 기준으로 **화면에 렌더링을 요청**
- 목표: React에서 발생하는 애니메이션, 레이아웃, 사용자 인터랙션에 올바른 결과물을 만드는 **반응성 문제를 해결**
  - 작업을 작은 단위로 분할하고 우선순위를 매김
  - 작업을 일시 중지하고 나중에 다시 시작할 수 있음
  - 이전에 했던 작업을 재사용하거나 필요하지 않으면 폐기할 수 있음
- **모든 과정이 비동기**로 이루어짐 (기존 렌더링 스택의 비효율성을 해결)
- **파이버**: 하나의 작업 단위로 구성
  → React: 작업 단위를 하나씩 처리하고 `finishedWork()` 작업으로 마무리
  → 작업을 커밋해 브라우저 DOM에 가시적인 변경사항을 만듦
  1. **렌더 단계**: React는 사용자에게 노출되지 않는 모든 비동기 작업을 수행(파이버 작업, 우선순위 지정, 중지 등)
  2. **커밋 단계**: DOM에 실제 변경 사항을 반영하기 위한 `commitWork()` 실행
- 파이버는 컴포넌트가 최초로 마운트되는 시점에 생성되어 이후에는 가급적이면 재사용됨
- state가 변경되거나 생명주기 메서드가 실행되거나 DOM의 변경이 필요한 시점 등에 실행
  → **리액트**: **파이버 작업의 우선순위를 정하고 스케줄링**

📌 **리액트 파이버 트리**

- **리액트** 내부의 파이버 트리
  1. 현재 모습을 담은 트리 `current`
  2. 작업 중인 상태를 나타내는 `workInProgress` 트리

     파이버 작업이 끝나면 리액트는 단순히 포인터만 변경해서 `workInProgress` 트리를 현재 트리로 바꿔버림 (더블 버퍼링)

📌 파이버의 작업 순서

1. 리액트는 `beginWork()`를 실행해 파이버 작업을 수행 - 더 이상 자식이 없는 파이버를 만날때까ㅣ
2. 작업이 끝나면 `completeWork()`를 실행해 파이버 작업을 완료
3. 형제가 있다면 형제로 넘어감
4. 2,3번이 끝나면 return으로 돌아가 작업이 완료됐음을 알림

### 파이버와 가상 DOM

- **파이버**: 리액트 컴포넌트에 대한 정보를 1:1로 가지고 있음 → 리액트 아키텍처 내부에서 비동기로 이루어짐
- 하지만 실제 브라우저 구조인 DOM에 반영하는 것인 동기적으로 일어나야 함
  ⇒ 가상 DOM을 통해 메모리상에서 작업을 먼저 수행해 결과물만 실제 브라우저 DOM에 반영
